name: Deploy to Google Cloud Functions

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write # Required for Workload Identity Federation

    steps:
      - uses: actions/checkout@v4

      # Install dependencies locally to ensure package-lock.json is generated/correct
      - name: Install Dependencies
        run: npm install
        working-directory: ./backend

      # Authenticate to Google Cloud using the Identity Pool we created
      - id: 'auth'
        name: 'Authenticate to Google Cloud'
        uses: 'google-github-actions/auth@v2'
        with:
          workload_identity_provider: '${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}'
          service_account: '${{ secrets.GCP_SERVICE_ACCOUNT }}'

      # Deploy the function to Google Cloud
      - id: 'deploy'
        name: 'Deploy Function'
        uses: 'google-github-actions/deploy-cloud-functions@v2'
        with:
          name: 'budgetwise-api'       # Name of the function in Google Cloud
          runtime: 'nodejs20'          # Node.js version
          entry_point: 'api'           # Must match the http('api', ...) in index.js
          region: 'us-central1'        # Region
          source_dir: './backend'      # Where your code lives
          # Pass environment variables to the function
          env_vars: |-
            MONGO_URI=${{ secrets.MONGO_URI }}
            JWT_SECRET=${{ secrets.JWT_SECRET }}
            HUGGINGFACE_API_KEY=${{ secrets.HUGGINGFACE_API_KEY }}
            GEMINI_API_KEY=${{ secrets.GEMINI_API_KEY }}
            NODE_ENV=production